# 1.0.3 Refactor Progress - Canvas = Layer Architecture

## Status: IN PROGRESS

Major architectural refactor to implement Penpot-inspired flat shapes map where Canvas = Frame shape.

## ✅ Completed

### 1. Data Structure Changes
- ✅ Removed `layers` array → flat `shapes` object (Map<id, shape>)
- ✅ Removed duplicate state: `canvasSize` and `artboardPosition`
- ✅ Added derived values from selectedFrame:
  - `canvasSize` = `{width: selectedFrame.width, height: selectedFrame.height}`
  - `artboardPosition` = `{x: selectedFrame.x, y: selectedFrame.y}`
- ✅ Renamed state variables:
  - `selectedLayerId` → `selectedShapeId`
  - `selectedObjectId` → now derived from `selectedShape`
  - `expandedLayers` → `expandedShapes`
  - `nextLayerIndexRef` → `nextFrameIndexRef`
  - `nextObjectIdRef` → `nextShapeIdRef`

### 2. Shape Creation
- ✅ `createCanvasDescriptor` → `createFrameShape` (returns frame shape with type: 'frame')
- ✅ `createObject` → `createShape` (uses x,y,width,height instead of frame object)
- ✅ Frame shapes have `children: []` array with child shape IDs
- ✅ Child shapes have `frameId` and `parentId` references

### 3. Core Functions Updated
- ✅ `pushUndoState` - works with shapes map
- ✅ `handleUndo/handleRedo` - serializes shapes map
- ✅ `ensureLayerExpanded` → `ensureFrameExpanded`
- ✅ `ensureLayerForObject` → `ensureFrameForShape`
- ✅ `appendObjectToLayer` → `addShapeToFrame`
- ✅ `updateObjectFrame` → `updateShapePosition`
- ✅ `updateObject` → `updateShape`
- ✅ `handleAddLayer` → `handleAddFrame`
- ✅ `handleDeleteLayer` → `handleDeleteFrame`
- ✅ `handleDeleteObject` → `handleDeleteShape`
- ✅ `toggleLayerVisibility` → `toggleShapeVisibility`
- ✅ `toggleObjectVisibility` → same function (toggleShapeVisibility)
- ✅ `moveLayer` → `moveFrame` (placeholder - no ordering in flat map yet)

### 4. Rendering Props
- ✅ LayersSidebar props updated to use frames with populated `objects` array
- ✅ CanvasArea props updated to use selectedFrame and frames
- ✅ Removed sync useEffect (lines 140-152) - NO LONGER NEEDED!

### 5. Derived State
- ✅ `selectedFrame` - derived from shapes map
- ✅ `selectedObject` - derived from selectedShape
- ✅ `frames` - filtered list of frame shapes with populated children
- ✅ `visibleShapes` - children of selected frame

## ⚠️ Still TODO

### 1. Shape Manipulation Functions
Many functions still need updating to work with flat shapes map:
- `applyFlip` - needs to update shape in map
- `applyRotation` - needs to update shape in map
- `handleStagePointerDown` - shape insertion logic
- `handleStagePointerMove` - drag draft logic
- `handleStagePointerUp` - finalize shape creation
- `handleObjectDragStart` - cloning logic
- `handleObjectDragEnd` - position updates
- `handleObjectTransformEnd` - transform updates
- `handleCanvasSelection` - selection logic
- All property change handlers in Inspector

### 2. Artboard Drag/Resize
Functions that manipulate frame position/size:
- `updateSelectedCanvas` - needs rewriting
- `handleArtboardPointerMove` - needs to update frame shape directly
- `onBeginArtboardDrag` - handler setup

### 3. Canvas Dialog
- `handleSaveCanvasSize` - needs to update selected frame dimensions

### 4. Render Functions
- `renderObject` - needs frame reference for positioning
- `renderDraft` - needs frameId context
- Need to pass `shapes` map to CanvasArea for child shape lookups

### 5. Inspector Updates
- All property change handlers need shape map updates
- Color picker, opacity, text properties, etc.
- Need to handle both frame properties and child shape properties

### 6. Testing
- Test empty state (0 frames)
- Test adding first frame
- Test adding shapes to frame
- Test selecting frames vs shapes
- Test undo/redo
- Test delete frame (removes children)
- Test visibility toggles

## Key Architecture Points

### NO Sync Needed
```js
// ❌ OLD: Manual sync in useEffect
useEffect(() => {
  if (frame.x !== artboardPosition.x) setArtboardPosition(...)
  if (frame.width !== canvasSize.width) setCanvasSize(...)
}, [selectedLayerId, layers])

// ✅ NEW: Derived directly
const canvasSize = selectedFrame
  ? { width: selectedFrame.width, height: selectedFrame.height }
  : DEFAULT_CANVAS
```

### Single Source of Truth
```js
// All shapes (including frames) in one flat map
shapes: {
  "frame-1": {
    type: "frame",
    x: 0, y: 0, width: 1200, height: 800,
    children: ["shape-1", "shape-2"]
  },
  "shape-1": {
    type: "rect",
    x: 100, y: 100, width: 200, height: 150,
    frameId: "frame-1",
    parentId: "frame-1"
  }
}
```

### Immutable Updates
```js
// ✅ Always create new object
pushUndoState({
  ...shapes,
  [shapeId]: {
    ...shapes[shapeId],
    x: newX,
    y: newY
  }
})
```

## Next Steps

1. **Complete shape manipulation functions** - highest priority
2. **Update all Inspector handlers** - property changes
3. **Test basic workflows** - add frame, add shape, move, delete
4. **Fix any TypeScript/runtime errors**
5. **Update CanvasArea rendering** - ensure only selected frame's children render
6. **Add frame ordering** - if needed (optional `order` property)

## Estimated Remaining Work

- ~2-3 hours to complete all function updates
- ~1 hour testing and bug fixes
- **Total**: ~3-4 hours

## Breaking Changes

- Empty state now shows "Empty" instead of default canvas
- User must click "+" to add first canvas/frame
- This matches the requirement: "on load there should be 0 layers and 0 items"

## Benefits Already Achieved

1. ✅ Canvas properties ARE frame properties (no sync issues)
2. ✅ Cleaner mental model (frame is a shape)
3. ✅ Removed ~15 lines of sync code
4. ✅ Easier to add multi-canvas support
5. ✅ Simpler undo/redo (one data structure)
