# 5.3.0 Effects — Hall of Mirrors

**Version:** 5.3.0
**Category:** Workshop / Effects
**Status:** Implemented
**Last Updated:** 2025-11-08

---

## Links

https://gsap.com/community/forums/topic/12735-displacement-mapping/

https://codepen.io/GreenSock/pen/mdoKMgG

https://pixijs.com/8.x/examples?example=filters_displacement_interactive

https://pixijs.com/8.x/examples?example=tiling-sprite_transform_animation

https://pixijs.com/8.x/examples?example=filters_displacement

https://pixijs.com/8.x/guides/getting-started/quick-start

https://u-e-n-o.com/ABOUT (horizontal glitch slice effect reference)

## Overview

Documentation for glass, distortion, and morphing visual effects that can be applied to components and layouts. These effects create smooth, organic distortions similar to funhouse mirrors, frosted glass, or liquid surfaces.

---

## Effect Types

### 1. SVG Displacement Maps
**Best for:** Organic, wavy distortion effects (hall of mirrors, ripples)

Creates smooth displacement using SVG filters with turbulence and displacement mapping.

**Implementation:**
```jsx
<svg style={{ position: 'absolute', width: 0, height: 0 }}>
  <filter id="goo">
    <feTurbulence
      type="turbulence"
      baseFrequency="0.01"
      numOctaves="2"
      result="turbulence"
    />
    <feDisplacementMap
      in2="turbulence"
      in="SourceGraphic"
      scale="20"
      xChannelSelector="R"
      yChannelSelector="G"
    />
  </filter>
</svg>

<div style={{ filter: 'url(#goo)' }}>
  {/* Content with distortion */}
</div>
```

**Parameters:**
- `baseFrequency`: Controls the size of the distortion (0.001-0.1)
- `numOctaves`: Complexity of the effect (1-4)
- `scale`: Intensity of displacement (1-50+)

**Use Cases:**
- Hover effects on cards
- Background distortions
- Transition effects
- Interactive elements

---

### 2. CSS Backdrop Filter
**Best for:** Frosted glass, translucent overlays

Modern CSS property for blur and color effects on backgrounds.

**Implementation:**
```css
.glass-surface {
  backdrop-filter: blur(10px) saturate(180%);
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
}
```

**Variations:**
```css
/* Subtle frost */
backdrop-filter: blur(8px);

/* Heavy blur with brightness */
backdrop-filter: blur(20px) brightness(1.1);

/* Glass with color tint */
backdrop-filter: blur(12px) saturate(150%) hue-rotate(10deg);
```

**Browser Support:**
- Chrome/Edge: ✅
- Firefox: ✅
- Safari: ✅
- Note: Requires `-webkit-` prefix in some browsers

**Use Cases:**
- Modal overlays
- Navigation bars
- Card surfaces
- Dropdown menus

---

### 3. GSAP with PixiPlugin
**Best for:** Smooth animated distortion, lens effects

Uses displacement sprites for water-like or lens distortion effects.

**Requirements:**
- GSAP (already in project)
- PixiPlugin
- Displacement texture/sprite

**Implementation:**
```javascript
import { gsap } from 'gsap'
import { PixiPlugin } from 'gsap/PixiPlugin'

gsap.registerPlugin(PixiPlugin)

// Animate displacement
gsap.to(displacementSprite, {
  x: 100,
  y: 100,
  duration: 2,
  ease: 'power2.inOut'
})
```

**Use Cases:**
- Hero backgrounds
- Image transitions
- Interactive galleries
- Scroll-based morphing

---

### 4. Framer Motion Distortion
**Best for:** Component morphing, layout animations

Leverages WebGL for smooth distortion during transitions.

**Requirements:**
- framer-motion (already in project: v12.23.22)

**Implementation:**
```jsx
import { motion } from 'framer-motion'

<motion.div
  initial={{ scale: 1 }}
  whileHover={{
    scale: 1.05,
    transition: { type: 'spring', stiffness: 300 }
  }}
  style={{
    transformOrigin: 'center',
    willChange: 'transform'
  }}
>
  {/* Content */}
</motion.div>
```

**Advanced:**
```jsx
// Custom distortion with layout animations
<motion.div
  layout
  layoutId="shared-element"
  transition={{
    layout: { duration: 0.6, ease: 'easeInOut' }
  }}
/>
```

**Use Cases:**
- Shared element transitions
- Card expansions
- Page transitions
- Morphing shapes

---

### 5. Lenis/Smooth Scroll Distortion
**Best for:** Scroll-triggered distortion effects

Adds subtle distortion during smooth scroll interactions.

**Note:** Not currently implemented in project. Would require:
- Lenis smooth scroll library
- Integration with existing GSAP ScrollTrigger

**Placeholder for future implementation**

---

### 6. PixiJS TilingSprite Effects
**Best for:** Repeating patterns, kaleidoscope effects, glitch aesthetics, morphing tiles

**Status:** ✅ Implemented in Hall of Mirrors apparatus page

Uses PixiJS v8 TilingSprite for WebGL-powered repeating texture effects with real-time manipulation.

**Installation:**
```bash
yarn add pixi.js
# Installed: pixi.js@8.14.0 (~120KB gzipped)
```

**Key Issue - Vite Compatibility:**
PixiJS v8 uses top-level await which conflicts with Vite. Must wrap async initialization in IIFE:

```javascript
// ❌ WRONG - causes build errors
useEffect(() => {
  setTimeout(async () => {
    await app.init(...)
  }, 100)
}, [])

// ✅ CORRECT - wrap in IIFE
useEffect(() => {
  const initPixi = async () => {
    await app.init(...)
  }

  setTimeout(() => {
    initPixi()
  }, 100)
}, [])
```

**Basic TilingSprite Pattern:**
```javascript
import { Application, Assets, TilingSprite } from 'pixi.js'

const app = new Application()
await app.init({ canvas, width, height, backgroundColor: 0x1a1a1a })

const texture = await Assets.load(imageSrc)
const tilingSprite = new TilingSprite({ texture, width, height })

// Control tile repetition
tilingSprite.tileScale.x = 0.3  // Narrower tiles
tilingSprite.tileScale.y = 1    // Normal height

// Animate position
app.ticker.add(() => {
  tilingSprite.tilePosition.x += speed
})
```

**React Pattern with Refs:**
```javascript
// Use refs to avoid stale closure in ticker
const speedRef = useRef(speed)
const animateRef = useRef(animate)

useEffect(() => {
  speedRef.current = speed
}, [speed])

app.ticker.add(() => {
  if (animateRef.current) {
    tilingSprite.tilePosition.x += speedRef.current
  }
})
```

---

## Implemented Variants

### Hall of Mirrors Apparatus Page
**Location:** `/styleguide/apparatus/hall-of-mirrors`
**File:** `apps/web/src/routes/styleguide/ApparatusHallOfMirrors.jsx`

**Total Effects:** 12 variants (8 SVG + 4 PixiJS)

#### SVG Displacement Variants (1-8):
1. **Subtle Ripple** - baseFrequency: 0.005, scale: 15
2. **Medium Wave** - baseFrequency: 0.01, scale: 25
3. **Heavy Distortion** - baseFrequency: 0.02, scale: 40
4. **Fine Grain** - baseFrequency: 0.03, numOctaves: 3, scale: 20
5. **Liquid Surface** - baseFrequency: 0.008, numOctaves: 2, scale: 30
6. **Animated Turbulence** - GSAP animates baseFrequency
7. **Extreme Warp** - baseFrequency: 0.015, scale: 60
8. **Glass Refraction** - baseFrequency: 0.012, scale: 35

#### PixiJS TilingSprite Variants (9-12):

**9. PixiJS Slices** (`PixiSliceVariant.jsx`)
- Vertical slice/repeat effect
- Controls: tileScaleX (slice width), speed (horizontal shift)
- Use case: Vertical fragmentation, repeating patterns

```javascript
tilingSprite.tileScale.x = tileScaleX  // 0.3 default
tilingSprite.tilePosition.x += speed   // Continuous shift
```

**10. PixiJS Glitch** (`PixiGlitchSliceVariant.jsx`)
- Horizontal scan line corruption aesthetic
- Inspired by: u-e-n-o.com/ABOUT portfolio effect
- Creates random horizontal offsets for image slices
- Controls: sliceCount, maxOffset, speed

```javascript
// Create horizontal slices with masks
const sliceHeight = height / sliceCount
for (let i = 0; i < sliceCount; i++) {
  const sprite = new Sprite(texture)
  const mask = new Graphics()
  mask.rect(0, i * sliceHeight, width, sliceHeight)
  sprite.mask = mask

  // Randomize offset on interval
  slice.targetOffset = (Math.random() - 0.5) * maxOffset * 2
  slice.currentOffset += (slice.targetOffset - slice.currentOffset) * 0.1
  sprite.x = baseX + slice.currentOffset
}
```

**11. PixiJS Morph** (`PixiMorphVariant.jsx`)
- Sin/cos scale breathing effect with diagonal shift
- Based on: PixiJS official TilingSprite example
- Creates organic pulsing/morphing pattern
- Controls: scaleIntensity, speed

```javascript
// Morphing scale (from PixiJS example)
count += 0.005 * speed
tilingSprite.tileScale.x = scaleIntensity + Math.sin(count)
tilingSprite.tileScale.y = scaleIntensity + Math.cos(count)

// Diagonal shift
tilingSprite.tilePosition.x += speed * 0.5
tilingSprite.tilePosition.y += speed * 0.5
```

**12. PixiJS Radial** (`PixiRadialVariant.jsx`)
- Circular orbital motion
- Tiles shift in circular path creating orbital kaleidoscope
- Controls: radius, tileScale, speed

```javascript
// Circular motion using sin/cos
angle += 0.02 * speed
tilingSprite.tilePosition.x = Math.cos(angle) * radius
tilingSprite.tilePosition.y = Math.sin(angle) * radius
```

---

## Control Panel Integration

**Component:** `DistortionControlsPanel.jsx`

**Unified Controls:**
- **Animation Toggle** - Enable/disable all animations
- **Lock/Drag Toggle** - Lock panel or allow drag with momentum
- **Scale Slider** (0-100) - Maps to different parameters per variant
  - SVG: Displacement intensity
  - Glitch: Maximum horizontal offset
  - Morph: Scale intensity
  - Radial: Orbit radius
- **Base Frequency Slider** (0.001-0.05) - Maps to:
  - SVG: Turbulence frequency
  - PixiJS: Animation speed multiplier
- **Octaves Slider** (1-4) - Maps to:
  - SVG: Complexity level
  - Glitch: Slice count (octaves × 5)
  - Radial: Tile scale

**Note:** Current limitation is that 3 sliders must map to different parameters per variant type. Future improvement: Separate control panels for SVG vs PixiJS effects.

---

## Per-Variant Features

**Shared Features (all 12 variants):**
- **ON/OFF Toggle** - Enable/disable effect individually
- **SELECT/UNSELECT** - Connect to control panel for adjustment
- **Image Upload** - Test effect with custom images (stored per-variant)
- **Info Hover** - Hover on title to see parameter explanations

**Info Overlay:**
- Absolute positioned at top of image
- `bg-surface-primary` at 60% opacity
- `textAbsoluteWhite` for readability
- Explains current parameter values and their effects

---

## Implementation Notes

### Component Architecture

**Variant Components:**
```
apps/web/src/components/styleguide/molecules/
  ├── PixiSliceVariant.jsx
  ├── PixiGlitchSliceVariant.jsx
  ├── PixiMorphVariant.jsx
  └── PixiRadialVariant.jsx
```

**Shared Pattern:**
```javascript
export default function PixiVariant({
  title,
  imageSrc,
  isEnabled,
  isSelected,
  onToggleEnabled,
  onToggleSelect,
  onImageUpload,
  animate,
  // ...variant-specific props
}) {
  const canvasRef = useRef(null)
  const appRef = useRef(null)

  // IIFE initialization pattern
  useEffect(() => {
    const initPixi = async () => { /* ... */ }
    const timer = setTimeout(() => initPixi(), 100)
    return () => {
      clearTimeout(timer)
      if (appRef.current) {
        appRef.current.destroy(true, {
          children: true,
          texture: true,
          baseTexture: true
        })
      }
    }
  }, [])

  // Conditional rendering: canvas when enabled, img fallback
  return (
    <div className="absolute inset-0" style={{ display: isEnabled ? 'block' : 'none' }}>
      <canvas ref={canvasRef} />
    </div>
  )
}
```

### State Management

**Page-level state:**
```javascript
// Track ON/OFF for each variant
const [variantEnabled, setVariantEnabled] = useState({
  'pixi-slices': false,
  'pixi-glitch': false,
  // ... all default to false for lighter page load
})

// Track which variant is selected for control panel
const [selectedVariant, setSelectedVariant] = useState('liquid-surface')

// Track uploaded images per variant
const [variantImages, setVariantImages] = useState({})
```

### Performance Considerations

**PixiJS:**
- ~120KB gzipped bundle increase
- WebGL rendering - GPU accelerated
- Each variant destroys on unmount to prevent memory leaks
- 100ms delay before init ensures DOM ready
- All variants OFF by default to reduce initial load

**SVG Filters:**
- Lightweight, no additional dependencies
- CPU-based rendering
- GSAP AttrPlugin for smooth attribute animations
- Can be performance-intensive on large areas

---

## Design System Integration

### Token Considerations
When implementing glass effects, use existing color tokens with opacity:

```css
/* Light mode glass */
.glass-light {
  background: color-mix(in srgb, var(--kol-surface-primary) 10%, transparent);
  backdrop-filter: blur(12px);
  border: 1px solid color-mix(in srgb, var(--kol-border-default) 20%, transparent);
}

/* Dark mode glass */
.glass-dark {
  background: color-mix(in srgb, var(--kol-surface-secondary) 15%, transparent);
  backdrop-filter: blur(12px) saturate(120%);
  border: 1px solid color-mix(in srgb, var(--kol-border-default) 30%, transparent);
}
```

### Performance Notes
- Use `will-change: transform` for animated distortions
- Limit backdrop-filter to small areas (performance-intensive)
- Consider reduced motion preferences:
  ```css
  @media (prefers-reduced-motion: reduce) {
    .distortion-effect {
      filter: none;
      backdrop-filter: none;
    }
  }
  ```

---

## Session Notes

### Session 1: Initial Implementation (2025-11-08)

**What We Built:**
- Installed PixiJS v8.14.0 (~120KB gzipped)
- Created 4 PixiJS TilingSprite variants
- Integrated with existing Hall of Mirrors apparatus page
- Implemented per-variant image upload
- Added info hover overlays with parameter explanations
- Fixed Vite/PixiJS top-level await conflict with IIFE pattern

**Issues Encountered:**
1. **Vite Compatibility** - PixiJS v8 top-level await requires IIFE wrapper
2. **Stale Closures** - Fixed using refs for ticker callbacks
3. **Control Panel Limitation** - 3 sliders must map to different params per variant type

### Session 2: Hall of Mirrors Restructure (2025-11-08)

**What We Built:**
- Restructured Hall of Mirrors into dedicated section with 5 sub-pages
- Separated SVG and PixiJS effects into distinct halls
- Standardized all halls to 3-column grids with 9-slot hard limit
- Created Hall of Archive for storing mixer experiments
- Built Hall of Symphony with 1024×600px performance canvas
- Added greyed-out placeholder slots (40% opacity) for unused capacity

**Navigation Structure:**
```
Hall of Mirrors (overview)
├── Hall of Displacement (8 SVG + 1 placeholder)
├── Hall of Movement (9 placeholders - GSAP coming soon)
├── Hall of Copies (4 PixiJS + 5 placeholders)
├── Hall of Symphony (1024×600px mixer canvas)
└── Hall of Archive (9 saved experiment slots)
```

**Design Decisions:**
- **9 Slot Hard Limit:** Prevents feature bloat and encourages curation
- **3-Column Grid:** Consistent across Displacement, Movement, Copies, and Archive
- **Single Canvas:** Symphony uses 1024×600px for performance benchmarking
- **Greyed Placeholders:** Visual rhythm without distraction (text-fg-32, opacity-40)
- **Technology Separation:** Each hall focuses on one approach (SVG/GSAP/PixiJS)

**Files Created:**
- `HallOfMirrors.jsx` - Overview/hero page
- `HallOfDisplacement.jsx` - SVG-only (cleaned from original)
- `HallOfMovement.jsx` - GSAP placeholder (9 empty slots)
- `HallOfCopies.jsx` - PixiJS-only (4 variants + 5 placeholders)
- `HallOfSymphony.jsx` - Performance mixer (1024×600px canvas)
- `HallOfArchive.jsx` - Saved experiments (9 slots)

**Files Modified:**
- `navigation.js` - Added Hall of Mirrors section with 5 children
- `Styleguide.jsx` - Added routes for all new halls + redirect from old path

---

### Session 3: Hall of Movement Breathing Animations (2025-11-08)

**What We Built:**
- Built 3 GSAP breathing animation variants with continuous easing control
- Created MovementControlsPanel following Displacement pattern
- Implemented continuous easing strength slider (0.5-4.0) for smooth interpolation
- Added vector shapes to Hall of Symphony (D and Ð at 400px tall)
- Created color and typography cheat sheets (2.1.1 and 2.2.1)

**Movement Variants:**
1. **Breathing Scale** - Uniform zoom (both axes)
2. **Breathing Stretch** - Non-uniform scale (different X/Y)
3. **Breathing Harmonica** - Horizontal stretch only (X axis)

**Control System:**
- **Duration** slider: 0.5s - 5s (breath cycle speed)
- **Amount** slider: 1.0x - 2.0x (scale intensity)
- **Cycle Strength** slider: 0.5 - 4.0 (continuous easing from sine to exponential)
- SELECT/UNSELECT pattern matching Hall of Displacement
- Shared control panel affects selected variant

**Key Innovation - Continuous Easing:**
```javascript
// Maps 0.5-4.0 to GSAP power functions
easing = `power${easingStrength.toFixed(1)}.inOut`
```
GSAP supports decimal power values, enabling smooth morphing between curves instead of discrete dropdown options.

**Files Created:**
- `MovementControlsPanel.jsx` - Control panel component with Duration/Amount/Cycle Strength
- `2.1.1-color-cheat-sheet.md` - Quick reference for color system
- `2.2.1-typography-cheat-sheet.md` - Quick reference for typography

**Files Modified:**
- `HallOfMovement.jsx` - Implemented 3 variants with SELECT pattern
- `HallOfSymphony.jsx` - Added vector shapes on absolute black background

**Session Log:** `SESSION-LOGS/2025-11-08-hall-of-movement-breathing-animations.md`

---

### Future Improvements
- [x] Separate control panels for SVG vs PixiJS effects (completed via separate halls)
- [x] Split Hall of Mirrors into multiple pages (completed)
- [x] Build out Hall of Movement with GSAP variants (3 variants complete, 6 more planned)
- [x] Create dedicated control panels for each technology (MovementControlsPanel complete)
- [ ] Add 6 more Movement variants to fill 9 slots
- [ ] Implement draggable panel with momentum physics (like Displacement)
- [ ] Implement Hall of Symphony mixer functionality
- [ ] Add Hall of Archive local storage persistence
- [ ] Add more PixiJS displacement filter variants
- [ ] Test performance on mobile devices
- [ ] Add accessibility considerations (reduced motion, keyboard controls)
- [ ] Create utility classes in `packages/ui/css/utilities.css`
- [ ] Export reusable effect components to `packages/ui/src/atoms/`

---

## Related Documentation
- `3.1.0-design-system-atoms.md` - Component building blocks
- `2.3.0-design-system-css-architecture.md` - CSS patterns
- `1.0.0-foundation-repository-structure.md` - Project structure

---

## References
- [SVG Filters - MDN](https://developer.mozilla.org/en-US/docs/Web/SVG/Element/filter)
- [backdrop-filter - MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/backdrop-filter)
- [GSAP PixiPlugin](https://greensock.com/docs/v3/Plugins/PixiPlugin)
- [Framer Motion](https://www.framer.com/motion/)
