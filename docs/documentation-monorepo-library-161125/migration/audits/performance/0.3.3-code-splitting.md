# Code Splitting Audit

**Document ID**: 0.3.3
**Parent**: [0.3.0-performance.md](./0.3.0-performance.md)
**Date**: 2025-11-15
**Status**: Not Started
**Category**: Performance - Code Splitting

---

## Objective

Implement strategic code splitting to reduce initial bundle size and improve page load times through lazy loading of route components and heavy modules.

---

## Current Architecture

**Routing Structure:**
- React Router v6 (assumed)
- 50+ defined routes
- Monolithic App.jsx imports

**Known Heavy Modules:**
- Chess workshop package (@kol/chess-data) - 177MB
- Pixi.js components (visualization)
- Documentation viewer
- Font viewer components
- Specimen pages

---

## Audit Checklist

### Route Analysis
- [ ] List all routes and their component sizes
- [ ] Identify heavy/rarely-accessed routes
- [ ] Map route dependencies
- [ ] Determine critical vs. non-critical paths

### Current Splitting Status
- [ ] Check for existing lazy imports
- [ ] Review Vite code-splitting config
- [ ] Analyze chunk generation
- [ ] Identify manual chunk definitions

### Opportunity Assessment
- [ ] Routes that should be lazy-loaded
- [ ] Components that can be dynamically imported
- [ ] Third-party libraries to split
- [ ] Data-heavy routes requiring async loading

---

## Code Splitting Strategies

### Level 1: Route-Based Splitting (High Priority)

**Pattern:**
```javascript
// Instead of:
import WorkshopChess from './routes/workshop/ChessComponents'

// Use:
const WorkshopChess = lazy(() => import('./routes/workshop/ChessComponents'))
```

**Target Routes for Lazy Loading:**
- `/workshop/chess/*` - Heavy chess data
- `/workshop/mirrors/*` - Pixi.js visualizations
- `/specimen/*` - Specimen pages (TG fonts)
- `/workshop/design-system/*` - Documentation
- Less-visited workshop routes

### Level 2: Component-Based Splitting (Medium Priority)

**Heavy Components to Split:**
```javascript
// Modal/overlay components
const VideoPlayer = lazy(() => import('./components/VideoPlayer'))

// Visualization components
const PixiRenderer = lazy(() => import('./components/pixi/PixiRenderer'))

// Font viewer
const GlyphInspector = lazy(() => import('./components/fontviewer/GlyphInspector'))
```

### Level 3: Library Splitting (Medium Priority)

**Third-Party Libraries:**
```javascript
// Chess library (177MB)
const chessData = () => import('@kol/chess-data')

// Pixi.js
const PIXI = () => import('pixi.js')

// Portable Text (Sanity CMS)
const PortableText = () => import('@portabletext/react')
```

---

## Implementation Patterns

### React.lazy + Suspense

```javascript
import { lazy, Suspense } from 'react'
import LoaderOverlay from './components/loaders/LoaderOverlay'

// Lazy load route
const ChessWorkshop = lazy(() => import('./routes/workshop/ChessComponents'))

// In routing:
<Route
  path="/workshop/chess/*"
  element={
    <Suspense fallback={<LoaderOverlay />}>
      <ChessWorkshop />
    </Suspense>
  }
/>
```

### Preloading on Hover

```javascript
// Preload on mouse enter for instant navigation
const preloadChess = () => import('./routes/workshop/ChessComponents')

<Link
  to="/workshop/chess"
  onMouseEnter={preloadChess}
>
  Chess Workshop
</Link>
```

### Route Groups

```javascript
// Group related routes
const workshopRoutes = {
  chess: () => import('./routes/workshop/ChessComponents'),
  mirrors: () => import('./routes/workshop/HallOfMirrors'),
  analytics: () => import('./routes/workshop/AnalyticsComponents')
}
```

---

## Vite Configuration

### Manual Chunk Splitting

```javascript
// vite.config.js
export default {
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          // Vendor chunks
          'vendor-react': ['react', 'react-dom', 'react-router-dom'],
          'vendor-ui': ['@kol/ui'],

          // Heavy libraries
          'chess-data': ['@kol/chess-data'],
          'pixi': ['pixi.js'],

          // Route groups
          'workshop': [
            './src/routes/workshop/ChessComponents',
            './src/routes/workshop/AnalyticsComponents'
          ]
        }
      }
    }
  }
}
```

### Chunk Size Warnings

```javascript
build: {
  chunkSizeWarningLimit: 500, // KB
  rollupOptions: {
    output: {
      // Prevent too many small chunks
      chunkFileNames: 'assets/[name]-[hash].js'
    }
  }
}
```

---

## Priority Routes for Splitting

### Critical (Keep in Main Bundle)
- `/` - Homepage
- `/work` - Portfolio
- `/foundry` - Foundry overview
- `/collections` - Collections overview
- Error pages (404, ErrorBoundary)

### High Priority (Lazy Load)
- `/workshop/chess/*` - 177MB chess data
- `/workshop/mirrors/*` - Pixi.js heavy
- `/specimen/*` - Specimen pages
- `/stack/*` - Blog articles

### Medium Priority (Optional Split)
- `/workshop/design-system/*` - Documentation
- `/foundry/specimens` - Specimens index
- `/collections/motion-graphics` - Video player

### Low Priority (Keep Bundled)
- `/studio` - Studio page
- `/foundry/licensing` - Licensing
- Navigation components
- Layout components

---

## Metrics to Track

**Before Code Splitting:**
- Main bundle size: TBD
- Initial page load: TBD
- Time to interactive: TBD
- Number of chunks: TBD

**After Code Splitting:**
- Main bundle size: Target <150KB
- Initial page load: Target <1s
- Lazy chunks count: TBD
- Average chunk size: TBD

**Per-Route Metrics:**
- Route load time: <500ms
- Chunk download time: <300ms
- Suspense fallback duration: <200ms

---

## Testing Strategy

### Manual Testing
1. Navigate to heavy routes (chess, mirrors)
2. Check network tab for chunk loading
3. Verify LoaderOverlay appears
4. Measure time to content visible
5. Test back/forward navigation

### Automated Testing
```javascript
// Test that lazy routes load
describe('Code Splitting', () => {
  it('should lazy load chess workshop', async () => {
    const { findByText } = render(<App />)
    fireEvent.click(await findByText('Chess Workshop'))
    expect(await findByText('Chess Components')).toBeInTheDocument()
  })
})
```

---

## Common Pitfalls

**1. Over-Splitting**
- Too many small chunks hurts performance
- HTTP/2 helps but not a cure-all
- Group related components

**2. No Fallback UI**
- Always provide Suspense fallback
- Use existing LoaderOverlay component
- Avoid blank screens

**3. Circular Dependencies**
- Can break code splitting
- Review import structure
- Use barrel exports carefully

**4. Vendor Splitting Issues**
- Don't split vendor too aggressively
- Keep React in main bundle
- Group related vendors

---

## Recommendations Template

**To be filled during audit:**

### Quick Wins
- TBD

### Route Splitting Plan
- TBD

### Component Splitting Plan
- TBD

### Vite Configuration Updates
- TBD

### Testing Requirements
- TBD

---

## Implementation Checklist

**Phase 1: Critical Routes (High Impact)**
- [ ] Lazy load chess workshop
- [ ] Lazy load mirrors/Pixi routes
- [ ] Lazy load specimen pages
- [ ] Add Suspense fallbacks
- [ ] Test navigation flows

**Phase 2: Heavy Components**
- [ ] Split video player modal
- [ ] Split font viewer components
- [ ] Split Pixi renderers
- [ ] Test component lazy loading

**Phase 3: Vendor Optimization**
- [ ] Configure manual chunks
- [ ] Group vendor libraries
- [ ] Split heavy third-party libs
- [ ] Verify chunk sizes

**Phase 4: Advanced (Optional)**
- [ ] Implement prefetching
- [ ] Add route preloading
- [ ] Optimize chunk caching
- [ ] Fine-tune chunk boundaries

---

## Expected Outcomes

**Bundle Size Reduction:**
- Main bundle: -40% (200KB â†’ 120KB)
- Initial load: -50% faster
- Route-specific chunks: 20-50KB each

**User Experience:**
- Faster initial page load
- Smooth route transitions
- Minimal perceived delay

**Developer Experience:**
- Clearer route organization
- Easier to reason about bundles
- Better build performance

---

## Related Documentation

- [0.3.1-bundle-size-audit.md](./0.3.1-bundle-size-audit.md) - Bundle analysis
- [React.lazy docs](https://react.dev/reference/react/lazy)
- [Vite code splitting](https://vitejs.dev/guide/build.html#chunking-strategy)

---

**Audit Date**: TBD
**Status**: Not Started
