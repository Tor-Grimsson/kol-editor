# Bundle Size Audit

**Document ID**: 0.3.1
**Parent**: [0.3.0-performance.md](./0.3.0-performance.md)
**Date**: 2025-11-15
**Status**: Not Started
**Category**: Performance - Bundle Analysis

---

## Objective

Analyze the production JavaScript and CSS bundle sizes to identify optimization opportunities and reduce the total payload delivered to users.

---

## Audit Checklist

### Setup
- [ ] Install bundle analyzer: `yarn add -D vite-plugin-visualizer`
- [ ] Configure visualizer in vite.config.js
- [ ] Run production build with analysis
- [ ] Generate bundle report

### Analysis Tasks
- [ ] Identify largest dependencies
- [ ] Find duplicate dependencies
- [ ] Locate unused code paths
- [ ] Analyze vendor chunk composition
- [ ] Review CSS bundle size
- [ ] Check for development-only code in production

### Metrics to Collect
- [ ] Total bundle size (uncompressed)
- [ ] Total bundle size (gzipped)
- [ ] Main chunk size
- [ ] Vendor chunk size
- [ ] Number of chunks
- [ ] Largest dependencies (top 10)

---

## Baseline Metrics

**Build Output - 2025-11-15:**
```
Build Time: 17.51s
Total Chunks: 117 JS files + 1 CSS file

MAIN BUNDLE (index-DgXVgojI.js):
- Uncompressed: 20,606.79 KB (20.1 MB) üî¥ CRITICAL
- Gzipped: 3,285.01 KB (3.2 MB) üî¥ CRITICAL
- Target: <200 KB gzipped
- OVER TARGET BY: 16x

CSS BUNDLE:
- Uncompressed: 228.18 KB ‚úÖ
- Gzipped: 33.53 KB ‚úÖ

CHESS DATA CHUNKS (106 files):
- Pattern: 2017-02.js through 2025-11.js
- Smallest: ~8KB gzipped (2020-11)
- Largest: ~692KB gzipped (2017-12)
- Total: ~88MB of assets folder
- STATUS: Loaded in main bundle (should be lazy)

Total Assets Folder: 88 MB
Total Dist Folder: 674 MB (includes videos/images)
```

---

## Expected Findings

**Common Issues to Look For:**

1. **Large Dependencies**
   - Lodash (if not tree-shaken)
   - Moment.js (if not replaced with lighter alternative)
   - Icon libraries (full sets vs. needed icons)
   - Chart/visualization libraries

2. **Duplicate Code**
   - Multiple versions of same package
   - Redundant polyfills
   - Duplicate CSS

3. **Development Code**
   - Debug logging
   - Development-only utilities
   - Sourcemaps in production

4. **Opportunity Areas**
   - Dynamic imports not utilized
   - Monolithic vendor chunks
   - Unoptimized images/assets in bundle

---

## Analysis Tools

**Vite Plugin Visualizer:**
```javascript
// vite.config.js
import { visualizer } from 'vite-plugin-visualizer'

export default {
  plugins: [
    visualizer({
      open: true,
      gzipSize: true,
      brotliSize: true,
    })
  ]
}
```

**Webpack Bundle Analyzer (if applicable):**
```bash
yarn add -D webpack-bundle-analyzer
```

**Manual Analysis:**
```bash
# List largest files
ls -lh dist/assets/*.js | sort -k5 -h

# Check gzipped sizes
gzip -c dist/assets/*.js | wc -c
```

---

## Optimization Strategies

### Quick Wins (High Impact, Low Effort)

1. **Tree Shaking Verification**
   - Ensure `sideEffects: false` in package.json
   - Use named imports for libraries
   - Check Vite build config for tree-shaking

2. **Lazy Loading Heavy Components**
   - Code split large visualization components
   - Defer non-critical UI components
   - Load workshop components on-demand

3. **Replace Large Libraries**
   - date-fns instead of moment (if used)
   - Lodash-es instead of lodash
   - Specific icon imports vs. full icon sets

### Medium Impact Optimizations

1. **Code Splitting**
   - Route-based splitting (see 0.3.3)
   - Vendor chunk optimization
   - Common chunk extraction

2. **Dynamic Imports**
   - Chess data package
   - Pixi.js components
   - Documentation viewer

3. **CSS Optimization**
   - Remove unused CSS
   - Inline critical CSS
   - Separate component CSS

### Deep Optimizations (Lower Priority)

1. **Dependency Replacement**
   - Find lighter alternatives
   - Remove unnecessary dependencies
   - Self-implement simple utilities

2. **Module Federation**
   - Share common dependencies
   - Lazy load packages
   - Micro-frontend architecture (future)

---

## Target Metrics

**Acceptable:**
- Total bundle (gzipped): <500KB
- Main chunk: <200KB
- Vendor chunk: <300KB

**Optimal:**
- Total bundle (gzipped): <300KB
- Main chunk: <150KB
- Vendor chunk: <150KB

---

## Findings

**Audit Completed: 2025-11-15**

### Root Cause Analysis

**üî¥ CRITICAL: Chess Data Loaded in Main Bundle**

The primary issue is that all 106 chess data chunks (2017-02 through 2025-11) are being bundled into the main JavaScript file instead of being lazy-loaded.

**Evidence:**
- Main bundle: 20.6MB uncompressed / 3.2MB gzipped
- Chess data total: ~177MB source data
- 106 separate month chunks created but not code-split
- These chunks appear in dist/assets but are imported eagerly

**Impact:**
- Users download 3.2MB on EVERY page load (even homepage!)
- Homepage doesn't use chess data at all
- Only `/workshop/chess/*` routes need this data
- Estimated unnecessary payload: ~3MB for non-chess pages

### Large Dependencies (Top Issues)

1. **@kol/chess-data package** - 177MB
   - Currently: Loaded in main bundle
   - Should be: Lazy loaded only on chess routes
   - Estimated savings: 3MB gzipped

2. **Pixi.js components**
   - WebGLRenderer: 63KB gzipped
   - WebGPURenderer: 37KB gzipped
   - SharedSystems: 51KB gzipped
   - Should be: Lazy loaded for mirror routes only

3. **React ecosystem** (acceptable)
   - React/ReactDOM in main bundle ‚úÖ
   - React Router in main bundle ‚úÖ

### Optimization Opportunities

**Immediate (Critical Impact):**

1. **Lazy Load Chess Workshop** üî¥ PRIORITY 1
   ```javascript
   // Current (WRONG):
   import ChessComponents from './routes/workshop/ChessComponents'

   // Should be:
   const ChessComponents = lazy(() => import('./routes/workshop/ChessComponents'))
   ```
   **Expected savings**: 3MB gzipped (~90% reduction in main bundle!)

2. **Lazy Load Pixi.js Routes** üî¥ PRIORITY 2
   - Hall of Mirrors routes
   - All visualization components
   **Expected savings**: ~150KB gzipped

3. **Lazy Load Specimen Pages** ‚ö†Ô∏è PRIORITY 3
   - Individual typeface specimens
   - Font viewer components
   **Expected savings**: ~100KB gzipped

### Recommended Actions

**Phase 1: Emergency Fix (30 min)**
- [ ] Implement lazy loading for chess workshop routes
- [ ] Test chess components still work
- [ ] Re-build and measure improvement
- **Expected result**: Main bundle <300KB gzipped

**Phase 2: Route Optimization (1 hour)**
- [ ] Lazy load Pixi.js mirror routes
- [ ] Lazy load specimen pages
- [ ] Lazy load documentation viewer
- **Expected result**: Main bundle <200KB gzipped

**Phase 3: Fine-tuning (Optional)**
- [ ] Configure manual chunks for vendor code
- [ ] Group related routes
- [ ] Implement route prefetching

---

## Implementation Priority

**üî¥ Critical (Must Fix Before Launch):**
1. **Chess Workshop Lazy Loading** - 3MB savings
   - File: `apps/web/src/App.jsx`
   - Impact: 90% bundle reduction
   - Effort: 15 minutes
   - Risk: Low (well-documented pattern)

**‚ö†Ô∏è High (Should Fix):**
2. **Pixi.js Mirror Routes** - 150KB savings
   - Files: Hall of Mirrors routes
   - Impact: Significant for non-mirror users
   - Effort: 30 minutes

3. **Specimen Pages** - 100KB savings
   - Files: Individual typeface routes
   - Impact: Moderate
   - Effort: 30 minutes

**üü¢ Medium (Nice to Have):**
4. **Manual Chunk Configuration** - Organization
   - File: `vite.config.js`
   - Impact: Better caching
   - Effort: 1 hour

5. **Vendor Splitting** - Optimization
   - Impact: Improved cache hit rates
   - Effort: 1 hour

**‚è≠Ô∏è Low (Future Enhancement):**
6. **Route Prefetching** - UX improvement
7. **Advanced Code Splitting** - Diminishing returns

---

## Verification

**After Optimizations:**
- [ ] Re-run bundle analyzer
- [ ] Compare before/after metrics
- [ ] Test production build
- [ ] Verify no broken functionality
- [ ] Update baseline metrics

---

---

## Results (Post-Optimization)

**Audit Date**: 2025-11-15
**Status**: ‚úÖ Phase 1 Complete (Progressive Loading Implemented)

### Achievements

**Homepage Bundle Reduction**: 46.7%
- Before: 3,285 KB gzipped
- After: 1,751 KB gzipped
- Savings: 1,533 KB (1.5 MB)

**Chess Data Successfully Lazy Loaded**:
- Main bundle: 1,751 KB (homepage - always loaded)
- Chess gameMeta chunk: 1,469 KB (lazy loaded on chess routes only)
- Monthly PGN chunks: ~88 MB total (loaded on user demand)

### Implementation Summary

1. **Created lightweight data file** (`generated/lightweight.js` - 136 KB)
   - Contains only manifest, monthlySummary, sampleGames
   - Excludes gameMeta (27,200 games, 19 MB)

2. **Refactored chess-data package**:
   - Disabled `getGameMeta()` - throws error
   - Added `loadMonthGames(month)` - progressive async loading
   - Created async helper functions
   - Static imports from lightweight file only

3. **Implemented progressive loading UI**:
   - Random month initial load (5 games only)
   - Memory usage indicator
   - Explicit "Load month" button
   - Month caching for instant switching

4. **Lazy loaded all chess routes**:
   - Chess, Analytics routes converted to lazy imports
   - Routes load only when navigated to

### Current State

| Metric | Value | Status |
|--------|-------|--------|
| Homepage bundle | 1,751 KB gzipped | ‚ö†Ô∏è Still 5.8x over 300 KB target |
| Chess data (lazy) | 1,469 KB gzipped | ‚úÖ Only loads on chess routes |
| Monthly chunks | 8-693 KB each | ‚úÖ User explicit load only |
| CSS bundle | 33.53 KB gzipped | ‚úÖ Acceptable |

### Files Modified

**Created**:
- `packages/chess-data/generated/lightweight.js` (136 KB)

**Modified**:
- `packages/chess-data/src/index.js` - Progressive loading API
- `apps/web/src/routes/Workshop.jsx` - Lazy route loading
- `apps/web/src/components/workshop/chess/apparatus/GameArchiveTable.jsx` - Complete rewrite (485 lines)

### Next Steps (Phase 2)

Homepage still needs optimization (1.75 MB ‚Üí target <300 KB):

1. **Lazy load Pixi.js** (Hall of Mirrors routes) - Est. 150 KB savings
2. **Lazy load specimen pages** - Est. 100 KB savings
3. **Lazy load documentation viewer** - Est. 50 KB savings
4. **Vendor chunk optimization** - Better caching
5. **Manual chunking configuration** - Improved organization

**Estimated total potential**: ~2MB ‚Üí ~250KB main bundle (88% reduction)

### Detailed Results

Full comparison document: `/tmp/bundle-comparison.md`

**Success Criteria**:
- ‚úÖ Chess data not in homepage bundle
- ‚úÖ Progressive loading implemented
- ‚úÖ User control over data loading
- ‚ö†Ô∏è Homepage bundle still over target (further work needed)

**Audit Date**: 2025-11-15
**Status**: ‚úÖ Phase 1 Complete - Progressive Chess Data Loading Implemented
