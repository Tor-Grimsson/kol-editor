---
version: 1.0.0
date: 2025-11-04
status: active
content-type: implementation
category: foundation
cross-references:
  parent: 1.0.0
  children: []
  related:
    - 1.0.0-documentation-layout-evolution
    - 0.0.2-documentation-layout-spec
    - 0.0.1-metadata-writing-guidelines
---

# 1.0.2 Foundation: Markdown Parser Implementation

## Overview

This document describes the comprehensive markdown parser utility (`parseDocsMarkdown.js`) that powers the documentation system's live markdown rendering. The parser supports both block-level and inline markdown elements, enabling rich documentation presentation within the styleguide at `/styleguide/design-system/documentation`.

**Key Features:**
- Full markdown syntax support (H1-H4, lists, code, links, images, etc.)
- Inline token processing (bold, italic, code, links)
- Frontmatter detection and skipping
- Structured output for React rendering
- Shared utility used by multiple components
- Table of contents auto-generation with nested hierarchy

## Context

The parser was created on 2025-11-04 to replace duplicate inline parsing logic in both `Documentations.jsx` and `DocumentationReader.jsx`. The original parsers were basic, supporting only H1/H2 headings and missing inline markdown features (bold, italic, inline code, links).

The existing `docs.css` stylesheet already included styles for H3, H4, strong tags, links, and inline code, but the parser wasn't extracting these elements from markdown. This enhancement bridges that gap.

## Supported Markdown Features

### Block-Level Elements

| Element | Syntax | Output |
|---------|--------|--------|
| H1 Heading | `# Heading` | Title-level heading |
| H2 Heading | `## Heading` | Section heading, creates TOC entry |
| H3 Heading | `### Heading` | Sub-section, nested TOC entry |
| H4 Heading | `#### Heading` | Sub-sub-section, nested TOC entry |
| Paragraph | Plain text | Body text with inline markdown |
| Unordered List | `- Item` or `* Item` | Bulleted list |
| Ordered List | `1. Item` | Numbered list |
| Code Block | ` ```code``` ` | Pre-formatted code |
| Blockquote | `> Quote` | Callout/quote block |
| Horizontal Rule | `---` | Divider |

### Inline Elements

| Element | Syntax | Output |
|---------|--------|--------|
| Bold | `**text**` | Strong emphasis |
| Italic | `*text*` | Emphasis |
| Inline Code | `` `code` `` | Monospace code snippet |
| Link | `[text](url)` | Clickable link |
| Image | `![alt](src)` | Embedded image |

### Special Handling

**Frontmatter:**
- YAML frontmatter between `---` delimiters is detected and skipped
- Allows metadata at document start without rendering

**List Continuity:**
- Consecutive list items of same type are grouped
- Maintains proper nesting structure

**Paragraph Buffering:**
- Multi-line text is joined into single paragraphs
- Empty lines trigger paragraph breaks

## Architecture

### Parser Structure

```
parseDocsMarkdown(markdown)
├── Returns: { sections, toc, introBlocks }
├── sections: Array of H2 sections with nested blocks
├── toc: Array of heading entries with levels
└── introBlocks: Content before first H2
```

### Processing Pipeline

1. **Line-by-line parsing** - Split markdown into lines
2. **State tracking** - Track code blocks, frontmatter, paragraph buffers
3. **Block detection** - Match headings, lists, code fences
4. **Inline processing** - Extract bold, italic, code, links from text
5. **Structure building** - Group blocks into sections
6. **TOC generation** - Extract headings with IDs and levels

### Token-Based Inline Rendering

Inline markdown is converted to tokens during parsing:

```javascript
"This is **bold** and `code`"
// Becomes:
[
  { type: 'text', content: 'This is ' },
  { type: 'bold', content: 'bold' },
  { type: 'text', content: ' and ' },
  { type: 'code', content: 'code' }
]
```

The `renderInlineTokens()` function converts tokens to React elements:

```jsx
renderInlineTokens(tokens) // Returns React elements
```

## Usage

### Basic Usage

```javascript
import { parseDocsMarkdown, renderInlineTokens } from '../../utils/parseDocsMarkdown'

const markdown = `# Title
## Section
This is **bold** and *italic*.
`

const { sections, toc, introBlocks } = parseDocsMarkdown(markdown)
```

### Rendering Parsed Content

```jsx
// Render intro content (before first H2)
{introBlocks.map((block, index) => {
  if (block.type === 'paragraph') {
    return (
      <p key={index}>
        {renderInlineTokens(block.tokens)}
      </p>
    )
  }
})}

// Render sections
{sections.map(({ heading, id, blocks }) => (
  <section key={id} id={id}>
    <h2>{heading}</h2>
    {blocks.map((block, index) => {
      // Render each block type
    })}
  </section>
))}
```

### Table of Contents

The parser auto-generates TOC entries with proper nesting:

```javascript
toc = [
  { id: 'overview', label: 'Overview', level: 2 },
  { id: 'features', label: 'Features', level: 3 },
  { id: 'advanced', label: 'Advanced Features', level: 4 }
]
```

Use the `level` property to indent nested entries:

```jsx
{toc.map((item) => {
  const indent = item.level === 3 ? 'pl-3' : item.level === 4 ? 'pl-6' : ''
  return (
    <li className={indent}>
      <a href={`#${item.id}`}>{item.label}</a>
    </li>
  )
})}
```

## Implementation Details

### File Location

**Primary:**
- `apps/web/src/utils/parseDocsMarkdown.js` - Parser utility

**Consumers:**
- `apps/web/src/routes/styleguide/Documentations.jsx` - Index/browser page
- `apps/web/src/routes/styleguide/DocumentationReader.jsx` - Individual doc reader

### CSS Integration

The parser outputs class names that match `packages/ui/css/docs.css`:

| Block Type | Class Name | CSS Selector |
|------------|------------|--------------|
| Paragraph | (none) | `.docs-article p` |
| H2 | (none) | `.docs-article h2` |
| H3 | (none) | `.docs-article h3` |
| H4 | (none) | `.docs-article h4` |
| List | `docs-list` | `.docs-list` |
| Code Block | `docs-codeblock` | `.docs-codeblock` |
| Blockquote | `docs-callout` | `.docs-callout` |
| Link | `docs-link` | `.docs-article a` |
| Image | `docs-image` | `.docs-image` |

Inline elements use semantic HTML tags styled by docs.css:
- `<strong>` for bold
- `<em>` for italic
- `<code>` for inline code
- `<a>` for links
- `<img>` for images

### Performance Considerations

**Memoization:**
Both consumer components use `useMemo()` to cache parsed results:

```javascript
const { sections, toc } = useMemo(() => {
  if (!rawMarkdown) return { sections: [], toc: [] }
  const parsed = parseDocsMarkdown(rawMarkdown)
  return { sections: parsed.sections, toc: parsed.toc }
}, [rawMarkdown])
```

**Single Pass:**
The parser processes markdown in a single pass, building all structures simultaneously.

**Token Caching:**
Inline tokens are generated during parsing, not during rendering, reducing per-render work.

## Testing

### Manual Testing

1. Navigate to `/styleguide/design-system/documentation`
2. Click any document with rich markdown
3. Verify all markdown features render correctly:
   - Headings at multiple levels
   - Bold and italic text
   - Inline code snippets
   - Code blocks with syntax
   - Lists (ordered and unordered)
   - Links are clickable
   - Images display properly

### Test Cases

**Basic markdown:**
```markdown
# Title
## Section
This is **bold**, *italic*, and `code`.
```

**Complex nesting:**
```markdown
## Features
### Core Features
- Item with **bold**
- Item with [link](url)
- Item with `code`
```

**Code blocks:**
```markdown
```javascript
const foo = 'bar'
```
```

**Edge cases:**
- Empty paragraphs
- Consecutive headings
- Mixed list types
- Frontmatter with various fields
- Long URLs
- Special characters in headings

## Limitations

**Not Supported:**
- Markdown tables (can be added if needed)
- Nested lists (single level only)
- HTML passthrough
- Task lists `- [ ]`
- Definition lists
- Footnotes
- Math expressions

**Regex-Based:**
The inline processor uses regex matching, which has limitations:
- Cannot handle escaped characters (`\*` for literal asterisk)
- May not match complex nested patterns
- Assumes well-formed markdown

**No Validation:**
The parser does not validate markdown syntax - malformed input may produce unexpected output.

## Future Enhancements

**Phase 2 Candidates:**
1. **Table support** - Parse markdown tables into structured data
2. **Nested lists** - Support multi-level list indentation
3. **Task lists** - Render checkboxes for `- [ ]` syntax
4. **Syntax highlighting** - Add language-specific code coloring
5. **Link resolution** - Auto-convert `[M.m.p]` references to doc links

**Phase 3 Candidates:**
1. **Custom containers** - Support `::: warning` style blocks
2. **Frontmatter parsing** - Extract and use metadata
3. **Heading anchors** - Auto-add anchor links to headings
4. **Copy buttons** - Add copy to code blocks
5. **Diff highlighting** - Support `diff` syntax in code blocks

## Related Documentation

**Conceptual:**
- [1.0.0 Documentation Layout Evolution](1.0.0-documentation-layout-evolution.md) - The docs layout concept this parser enables
- [0.0.2 Documentation Layout Spec](0.0.2-documentation-layout-spec.md) - Detailed layout specification

**System:**
- [0.0.1 Writing Guidelines](0.0.1-metadata-writing-guidelines.md) - Markdown syntax standards
- [0.0.0 Documentation System](0.0.0-documentation-index.md) - Overall system design

**Design:**
- CSS: `packages/ui/css/docs.css` - Styling for rendered markdown
- Components: `apps/web/src/components/styleguide/docs/` - Layout wrappers

## Changelog

### Version 1.0.0 (2025-11-04)

**Added:**
- Initial implementation of markdown parser
- Support for H1-H4 headings
- Support for inline markdown (bold, italic, code, links, images)
- Inline token processing system
- TOC generation with nested levels
- Frontmatter detection
- React rendering utilities

**Changed:**
- Replaced duplicate parsing logic in Documentations.jsx
- Replaced duplicate parsing logic in DocumentationReader.jsx
- Unified markdown processing across documentation system

**CSS Additions:**
- H4 heading styles
- Link styles with hover states
- Inline code background and padding
- Strong/bold text emphasis
- Italic text styling
- Image max-width and border-radius

## Migration Notes

**For Future Development:**

If you need to modify markdown parsing behavior:

1. Update `apps/web/src/utils/parseDocsMarkdown.js`
2. Add corresponding CSS to `packages/ui/css/docs.css` if needed
3. Test in both Documentations.jsx (index) and DocumentationReader.jsx (individual docs)
4. Update this document with changes

**Backward Compatibility:**

The parser maintains backward compatibility with the previous basic parser:
- All previously supported syntax still works
- Output structure is identical for basic elements
- Enhanced features are additive, not breaking

---

**Last Updated:** 2025-11-04
**Maintained by:** Design System Team
**Status:** Active - Production Ready
