---
version: 1.0.0
date: 2025-11-16
status: active
content-type: implementation
category: pages
cross-references:
  parent: 4.0.3
  related:
    - packages/content/src/schemas/types/blog.ts
    - packages/content/src/queries.ts
    - apps/web/src/routes/Article.jsx
---

# 4.0.32 Stack — Sanity Settings & Schema

> Recovered from `docs/a-torg/stack-previous-md/7.3.5-prose-article-sanity-integration.md`. Use this when wiring Stack to Sanity or debugging missing fields like `type = "research"`.

## Environment Configuration
Set these in `apps/web/.env` (and `.env.local` for Studio when needed):

```bash
VITE_SANITY_PROJECT_ID=<project_id>
VITE_SANITY_DATASET=projects
VITE_SANITY_API_VERSION=2025-01-01
VITE_SANITY_USE_CDN=true
```

## Core Schema (`blog` document)
File: `packages/content/src/schemas/types/blog.ts`

| Field | Type | Notes |
|-------|------|-------|
| `title` | string | Required |
| `slug` | slug | Mirrors title by default |
| `excerpt` | text | 300 char helper for Stack hero/SEO |
| `author` | reference | Points to `author` document |
| `publishedAt` | datetime | Required; drives ordering |
| `featured` | boolean | Flags hero/highlight candidates |
| `coverImage` / `thumbnail` | image | Hero + card art |
| `body` | Portable Text | Rich article content |
| `tags` | array<string> | Powers Tag pills |
| `relatedProjects` | array<ref> | Used by future cross-links |
| `sources` | array<object> | Rendered by `SourcesSection` |
| `type` | string | **Research vs Standard layout toggle** (defaults to research) |

### Article Type Field
```ts
defineField({
  name: 'type',
  title: 'Article Type',
  type: 'string',
  group: 'meta',
  initialValue: 'standard',
  options: {
    list: [
      { title: 'Standard Blog Post', value: 'standard' },
      { title: 'Research Article', value: 'research' }
    ],
    layout: 'radio'
  },
  description: 'Choose the layout and features for this article'
})
```
- Selecting **Research Article** (default) activates the two-column layout (see `4.0.31` and `4.0.34`). Switch to **Standard Blog Post** for the single-column Portable Text layout.
- If Studio complains about unknown field `type` (current issue), redeploy this schema via `yarn workspace @kol/content sanity-deploy` or `yarn workspace @kol/content typecheck` to ensure the Studio build picks up the change.

## Queries
File: `packages/content/src/queries.ts`

- `BLOG_DETAIL` (slug lookup) — must include `type`, `sources`, `body`, related projects, tags, hero media.
- `BLOG_LIST` — summary listing for Stack page (`getLatestBlogPosts` wrapper).
- `BLOG_FEATURED` — hero + highlight picks.

Example snippet (detail query):
```ts
export const BLOG_DETAIL = `*[_type == "blog" && slug.current == $slug][0]{
  _id,
  title,
  "slug": slug.current,
  type,
  excerpt,
  publishedAt,
  author->{
    _id,
    name,
    "slug": slug.current,
    bio,
    image{..., asset->{ url, metadata{dimensions, lqip} }}
  },
  coverImage{..., asset->{ url, metadata{dimensions, lqip} }},
  body[],
  sources[]{ title, url, meta },
  tags,
  relatedProjects[]->{ _id, title, "slug": slug.current, description }
}`
```

## Runtime Flow
1. `apps/web/src/routes/Article.jsx` grabs the slug via `useParams`.
2. Fetches `BLOG_DETAIL`; calculates reading time (~200 WPM) + formats dates.
3. Determines `article.type || 'standard'`.
4. Passes data to the correct layout (see `4.0.34`).

## Studio Workflow
1. Run `yarn workspace @kol/content studio` (or `cd apps/studio && npm run dev`).
2. Create/Edit a “Blog Post” document.
3. Fill required fields and select **Article Type** radio.
4. Publish → preview via `/article/<slug>`.

## Troubleshooting
- **Unknown field `type`:** Schema not deployed; run `yarn workspace @kol/content sanity-deploy`.
- **Missing body content:** Ensure Portable Text blocks are under `body[]`.
- **Hero not showing:** Provide `coverImage` with asset reference; `thumbnail` used for cards.
- **Tags not filtering on Stack:** Confirm `tags` array is filled; `getLatestBlogPosts` derives tag options from `tags` field.

Keep this doc in sync whenever schema fields or env requirements change to avoid future “field not defined” regressions.
