# 5.1.3 Chessboard & Controls Integration Plan

**Version:** 1.0
**Date:** 2025-11-07
**Status:** Implementation In Progress
**Content Type:** implementation
**Category:** chess-integration

---

# Chessboard & Controls Integration

**Purpose:** Build interactive chessboard and control system to visualize and interact with chess games from the 27,200-game dataset.

## Project Overview

**Phase 1:** Chessboard-centric implementation
- Load and display individual games on an interactive board
- Implement move-by-move navigation (forward/backward)
- Display game metadata (players, ratings, date, result, ECO)
- Real-time board state updates

**Phase 2:** Controls enhancement
- Game selection interface
- Time control filtering
- Advanced navigation features (jump to move, annotations)
- Playback controls (play/pause, speed control)

## 2025-11-07 Progress Update
- Fixed the legacy `ChessComponents.jsx` showcase by extracting `LegacySidebarPreview` into a self-contained component. This resolves the `return outside function` compile error and keeps the historical sidebar reference functional for regression testing.
- Added a `board-playback--sidebar-360` modifier that sets `--board-sidebar-width: 360px`, ensuring Chess Analysis (and any future adopters) can lock the controls column to the required 360 px width without impacting other board layouts.
- Updated `ChessAnalysis.jsx` to wrap both the live sidebar and the Alternative Controls mock in 360 px containers so the plan’s “single-view demo” requirement is met with consistent sizing across mock and production components.
- Next focus: keep migrating the Alternative Controls mock into the shared provider (variation tree + edit mode actions) and evaluate whether the legacy sidebar preview can be retired once parity is confirmed.

## Data Requirements

### Game Data Structure
```javascript
{
  "id": "b906babc-62c9-11e1-8000-000000010001",
  "url": "https://www.chess.com/game/live/1960894102",
  "startTime": null,
  "endTime": 1487602992,
  "month": "2017-02",
  "rated": true,
  "timeClass": "blitz",
  "timeControl": "600",  // seconds
  "eco": "https://www.chess.com/openings/Scandinavian-Defense-2.exd5",
  "playerColor": "white",
  "playerResult": "win",
  "player": {
    "username": "Biskupstunga",
    "rating": 929,
    "result": "win"
  },
  "opponent": {
    "username": "DARTH-ZANE",
    "rating": 619,
    "result": "resigned"
  },
  "termination": "Biskupstunga won by resignation",
  "terminationCategory": "win-resignation",
  "pgn": "1.e4 d5 2.exd5 Qxd5 3.Nc3 Qa5 ...", // Need PGN
  "moves": [
    {
      "moveNumber": 1,
      "turn": "white",
      "from": "e2",
      "to": "e4",
      "piece": "pawn",
      "san": "e4",
      "fen": "rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq e3 0 1"
    }
  ],
  "annotations": {
    "mistakes": [moveNumber, ...],
    "blunders": [moveNumber, ...],
    "brilliancies": [moveNumber, ...]
  }
}
```

**Issue Identified:** PGN and move-by-move data is not currently available in the dataset. We need to:
1. **Request PGN data** from the data source
2. **Parse moves** into a structured format
3. **Generate FEN positions** for each move
4. **Identify annotations** (if available from source)

---

## Phase 1: Chessboard Implementation

### Component Architecture

**Core Components:**
1. **ChessBoard** - Visual board with pieces
2. **GameLoader** - Fetches and parses game data
3. **MoveNavigator** - Controls for move-by-move navigation
4. **GameInfo** - Displays game metadata
5. **BoardState** - Manages current position and move history

### Implementation Steps

#### Step 1: Data Enhancement
**Goal:** Add PGN and move data to the chess dataset

**Tasks:**
1. Create `chessGameHelpers.js` with:
   - `parsePgnToMoves(pgn)` - Parse PGN into structured move objects
   - `generateFenFromMoves(moves)` - Generate FEN for each position
   - `validateMoveSequence(moves)` - Validate move integrity
   - `getMoveByIndex(moves, index)` - Get move at specific position

**Data Structure:**
```javascript
// Example move object
{
  moveNumber: 1,
  turn: "white",
  from: "e2",
  to: "e4",
  piece: "pawn",
  san: "e4",
  lan: "e2-e4",
  fen: "rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq e3 0 1",
  isCheck: false,
  isCheckmate: false,
  isCapture: false,
  isPromotion: false,
  promotionPiece: null,
  timestamp: null
}
```

**Dependency:** Requires PGN data source or external PGN parser

---

#### Step 2: ChessBoard Component
**Goal:** Create interactive chessboard visualization

**Current State:** `apps/web/src/components/styleguide/chess/apparatus/ChessBoard.jsx` exists
**Enhancement Needed:** Add interactive features

**Features to Add:**
1. **Position Display**
   - Render pieces at current move
   - Handle FEN notation input
   - Responsive sizing (448px × 448px reference)

2. **Visual Enhancements**
   - Last move highlight
   - Check highlighting
   - Captured pieces display
   - Move numbers overlay

3. **Piece Animation**
   - Smooth move transitions
   - Capture animations
   - Castling visualization
   - Promotion dialog

**Technical Considerations:**
- Use chess.js library for move validation
- Generate piece images or use Unicode chess symbols
- Implement drag-and-drop or click-to-move
- Mobile touch gesture support

---

#### Step 3: Move Navigator
**Goal:** Implement game playback controls

**UI Elements:**
1. **Navigation Controls**
   - ◀ Previous move
   - ▶ Next move
   - ⏮ First move (start)
   - ⏭ Last move (end)
   - Slider/jump to specific move

2. **Playback Options**
   - ▶ Play/pause button
   - Speed control (1x, 2x, 3x, instant)
   - Auto-play on load
   - Loop mode

3. **Visual Feedback**
   - Current move indicator
   - Move counter (Move 15/42)
   - Progress bar

**Implementation:**
```javascript
const MoveNavigator = ({ moves, currentMove, onMoveChange }) => {
  const handleNext = () => onMoveChange(currentMove + 1)
  const handlePrevious = () => onMoveChange(currentMove - 1)
  const handleSliderChange = (value) => onMoveChange(value)

  return (
    <div className="move-navigator">
      {/* Controls */}
    </div>
  )
}
```

---

#### Step 4: Game Info Display
**Goal:** Show comprehensive game metadata

**Information to Display:**
1. **Player Information**
   - White player name and rating
   - Black player name and rating
   - Result (1-0, 0-1, 1/2-1/2)
   - Your color (white/black)

2. **Game Details**
   - Date played
   - Time control (e.g., "5+0 Blitz")
   - Time class (blitz/bullet/rapid/daily)
   - Rated/Unrated
   - ECO code (if available)

3. **Game Outcome**
   - Termination reason
   - Move count
   - Opening name (parsed from ECO)

4. **Statistics** (if available)
   - Accuracy percentage
   - Blunder/mistake count
   - Time spent per move
   - Puzzle attempts

**Design System Classes:**
- Header: `kol-heading-lg`
- Labels: `kol-mono-sm text-fg-64 uppercase tracking-widest`
- Values: `kol-text-md text-fg`
- Badges: `kol-mono-xs` with status colors

---

#### Step 5: Game State Management
**Goal:** Centralize game logic and state

**State Management:**
```javascript
const useGameState = (gameData) => {
  const [currentMove, setCurrentMove] = useState(0)
  const [isPlaying, setIsPlaying] = useState(false)
  const [playbackSpeed, setPlaybackSpeed] = useState(1) // 1x, 2x, 3x

  const currentPosition = useMemo(() => {
    return gameData.moves[currentMove]?.fen || gameData.initialFen
  }, [gameData, currentMove])

  const totalMoves = gameData.moves?.length || 0

  return {
    currentMove,
    setCurrentMove,
    isPlaying,
    setIsPlaying,
    playbackSpeed,
    setPlaybackSpeed,
    currentPosition,
    totalMoves,
    canGoBack: currentMove > 0,
    canGoForward: currentMove < totalMoves
  }
}
```

**Integration with ChessBoard:**
- Pass FEN to ChessBoard for position rendering
- Update position when currentMove changes
- Highlight last move visually

---

## Phase 2: Controls Enhancement

### Game Selection Interface

**Goal:** Browse and select games from dataset

**UI Components:**
1. **Game Browser**
   - List view of games
   - Filter by time control
   - Filter by date range
   - Filter by opponent
   - Search by ECO/opening

2. **Game Cards**
   - Compact preview
   - Date, opponent, result
   - Time control badge
   - ECO code
   - Click to load

**Data Filtering:**
```javascript
const filterGames = (games, filters) => {
  return games.filter(game => {
    if (filters.timeClass && game.timeClass !== filters.timeClass) return false
    if (filters.dateFrom && game.month < filters.dateFrom) return false
    if (filters.dateTo && game.month > filters.dateTo) return false
    if (filters.playerColor && game.playerColor !== filters.playerColor) return false
    if (filters.result && game.playerResult !== filters.result) return false
    return true
  })
}
```

---

### Advanced Navigation

**Features:**
1. **Move List Panel**
   - Click any move to jump
   - Highlight current move
   - Show SAN notation
   - Fold/unfold variations

2. **Bookmark System**
   - Save interesting positions
   - Quick jump to bookmarks
   - Annotate positions with notes

3. **Keyboard Shortcuts**
   - Space: play/pause
   - Left/Right arrows: previous/next
   - Home/End: first/last
   - Number keys: jump to move
   - S: save position

---

### Time Control Integration

**Goal:** Filter and analyze games by time control

**Visual Enhancements:**
- Color-coded borders for time classes
- Time control filter UI
- Speed indicator (moves/minute)
- Time pressure analysis

**Data Display:**
- Average time per move
- Time management stats
- Time trouble situations
- Time control preference trends

---

## Technical Architecture

### File Structure
```
apps/web/src/components/styleguide/chess/
├── apparatus/
│   ├── ChessBoard.jsx (enhanced)
│   ├── MoveNavigator.jsx (new)
│   ├── GameInfo.jsx (new)
│   ├── GameBrowser.jsx (new)
│   └── GameControls.jsx (new)
├── utils/
│   ├── chessGameHelpers.js (new)
│   └── fenHelpers.js (new)
└── data/
    ├── gameLoader.js (new)
    └── gameCache.js (new)
```

### Dependencies
1. **chess.js** - Chess rules and move validation
2. **chessboard.js** or custom - Board rendering (if needed)
3. **@kol/chess-data** - Enhanced with PGN data
4. **react-use** - Custom hooks for game state

### Performance Considerations
1. **Lazy Loading** - Load PGN on-demand
2. **Move Caching** - Cache computed FEN positions
3. **Virtual Scrolling** - For game list (if large)
4. **Web Workers** - Parse PGN off-main-thread
5. **Memory Management** - Clear unused game data

---

## Data Enhancement Strategy

### Option 1: PGN from Source
**Best Case:** Source provides PGN data
- Parse PGN into move objects
- Generate FEN for each position
- Minimal custom logic needed

**Implementation Time:** 1-2 days

### Option 2: Fetch on Demand
**If PGN not available:**
- Fetch PGN from chess.com URL
- Cache PGN locally
- Parse on first load

**Implementation Time:** 2-3 days

### Option 3: Generate from Game Meta
**If PGN unavailable:**
- Request PGN data enhancement
- Partner with data source
- Custom PGN generation

**Implementation Time:** 3-5 days (requires data work)

### Option 4: Sample Implementation
**For immediate development:**
- Create 5-10 sample games with PGN
- Build full interface
- Plug in real data later

**Implementation Time:** 1 day

---

## Implementation Phases

### Phase 1A: Foundation (Day 1)
- [ ] Create chessGameHelpers.js with PGN parser
- [ ] Enhance ChessBoard component
- [ ] Implement basic move navigation
- [ ] Load sample games

**Deliverable:** Working chessboard with 1 game, basic navigation

### Phase 1B: Core Features (Day 2)
- [ ] Complete move navigator UI
- [ ] Add game info display
- [ ] Implement playback controls
- [ ] Polish animations

**Deliverable:** Full chessboard with one game playback

### Phase 1C: Multi-Game Support (Day 3)
- [ ] Create game browser interface
- [ ] Implement game selection
- [ ] Add game filtering
- [ ] Test with 10+ games

**Deliverable:** Multi-game support with selection

### Phase 2A: Advanced Controls (Day 4)
- [ ] Keyboard shortcuts
- [ ] Move list panel
- [ ] Bookmark system
- [ ] Speed controls

**Deliverable:** Full control suite

### Phase 2B: Time Control Analysis (Day 5)
- [ ] Time control filtering
- [ ] Time management stats
- [ ] Visual enhancements
- [ ] Analytics integration

**Deliverable:** Complete chessboard & controls system

**Total Estimated Time:** 5 days (40 hours)

---

## Success Criteria

### Minimum Viable Product
- [ ] Display chess position on interactive board
- [ ] Navigate through game moves (forward/back)
- [ ] Show game info (players, result, date)
- [ ] Load at least 1 game successfully

### Production Ready
- [ ] Load any game from dataset
- [ ] Smooth navigation with animations
- [ ] Game browser with filtering
- [ ] Keyboard shortcuts
- [ ] Mobile responsive
- [ ] Zero errors in all game flows

### Enhanced Features
- [ ] Multiple game support
- [ ] Time control analysis
- [ ] Bookmark system
- [ ] Opening explorer
- [ ] Accuracy tracking
- [ ] Export positions

---

## Risk Assessment

### High Risk
1. **PGN Data Unavailable**
   - **Impact:** Cannot implement move-by-move
   - **Mitigation:** Fetch from chess.com, use sample data, or request data enhancement
   - **Contingency:** Static board with final position

2. **Performance Issues**
   - **Impact:** Slow loading, laggy navigation
   - **Mitigation:** Lazy loading, caching, Web Workers
   - **Contingency:** Reduce features, optimize critical path

### Medium Risk
1. **Chess Logic Complexity**
   - **Impact:** Bugs in move validation, FEN generation
   - **Mitigation:** Use established chess.js library
   - **Contingency:** Simplify features, focus on display

2. **Mobile Touch Gestures**
   - **Impact:** Poor mobile experience
   - **Mitigation:** Test on devices, use touch libraries
   - **Contingency:** Desktop-first, basic mobile support

### Low Risk
1. **Design System Integration**
   - **Impact:** Inconsistent styling
   - **Mitigation:** Follow established patterns, use kol-* classes
   - **Contingency:** Core functionality over styling

---

## Open Questions

1. **Data Source**
   - Can we get PGN data from the current dataset?
   - Should we fetch PGN from chess.com URLs?
   - How to handle CORS issues?

2. **Chess Library**
   - Use chess.js or chessboard.js?
   - Custom implementation needed?
   - Size impact on bundle?

3. **Piece Graphics**
   - Unicode symbols or image files?
   - Theme support (pieces set selection)?
   - Animation library needed?

4. **Game Database**
   - How to efficiently store/cache games?
   - Client-side or server-side processing?
   - Indexing strategy for searching?

5. **User Preferences**
   - Save last position?
   - Remember playback speed?
   - History of viewed games?

---

## Next Steps

1. **Immediate (Today)**
   - [ ] Decide on PGN data approach
   - [ ] Set up development environment
   - [ ] Create sample PGN games
   - [ ] Install chess.js library

2. **Tomorrow**
   - [ ] Build basic chessboard component
   - [ ] Implement FEN rendering
   - [ ] Create move navigator
   - [ ] Test with sample game

3. **This Week**
   - [ ] Complete Phase 1A-C
   - [ ] Add game browser
   - [ ] Polish UI/UX
   - [ ] Test with full dataset

4. **Next Week**
   - [ ] Complete Phase 2A-B
   - [ ] Advanced features
   - [ ] Performance optimization
   - [ ] Documentation

---

## Reference Links

**Chess Libraries:**
- chess.js: https://github.com/jhlywa/chess.js
- chessboard.js: https://chessboardjs.com/
- react-chessboard: https://react-chessboard.vercel.app/

**PGN Parsing:**
- PGN Standard: https://www.chess.com/article/view/how-to-read-pgn-chess-notation
- pgn-parser: https://github.com/mliebelt/pgn-parser

**Chess Resources:**
- FEN Notation: https://en.wikipedia.org/wiki/Forsyth%E2%80%93Edwards_Notation
- Chess Rules: https://www.fide.com/FIDE/handbook/LawsOfChess.pdf

---

## Project Timeline

| Phase | Tasks | Estimated Time |
|-------|-------|----------------|
| **Phase 1A** | Foundation & Basic Board | 1 day |
| **Phase 1B** | Core Features & Navigation | 1 day |
| **Phase 1C** | Multi-Game Support | 1 day |
| **Phase 2A** | Advanced Controls | 1 day |
| **Phase 2B** | Time Control Analysis | 1 day |
| **Total** | | **5 days** |

**Start Date:** 2025-11-08
**Target Completion:** 2025-11-12
**Critical Path:** PGN data availability

---

## Budget & Resources

**Time:** 40 hours
**Priority:** High
**Dependencies:** PGN data, chess.js library
**Testing:** Manual testing, game validation
**Documentation:** Inline code, user guide

---

**Author:** Claude Code
**Review:** 2025-11-07
**Status:** Ready for Implementation
**Next Action:** Begin Phase 1A development

---

*End of Planning Document*
